<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venture Finance Analyzer - èèµ„å†³ç­–åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }
        
        .tab-button {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button:hover {
            color: #667eea;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .round-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .round-item input {
            flex: 1;
        }

        .round-item input[type="number"] {
            min-width: 120px;
        }

        .round-item:has(input[type="number"][min="0"][max="1"]) {
            grid-template-columns: 2fr 1fr;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .round-item {
                flex-direction: column;
                gap: 10px;
            }

            .round-item input {
                width: 100%;
            }
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .results {
            margin-top: 30px;
        }
        
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .result-card h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h5 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .lock-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            transition: transform 0.2s;
        }
        
        .lock-btn:hover {
            transform: scale(1.2);
        }
        
        .cell-lock-btn {
            position: absolute;
            right: 2px;
            top: 2px;
            background: none;
            border: none;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            width: 18px;
            height: 18px;
            opacity: 0.4;
            transition: all 0.2s;
            line-height: 18px;
        }
        
        td:hover .cell-lock-btn {
            opacity: 1;
        }
        
        .cell-lock-btn:hover {
            opacity: 1 !important;
            font-size: 14px;
        }
        
        .locked-cell {
            background: #ffe6e6 !important;
            border: 2px solid #ff9999 !important;
        }
        
        .auto-cell {
            background: #fff8dc !important;
        }
        
        .manual-cell {
            background: white !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° Venture Finance Analyzer</h1>
            <p>è‚¡æƒç¨€é‡Šã€ä¼°å€¼åˆ†æä¸é£é™©æ¨¡æ‹Ÿ</p>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab(0)">æ¯å…¬å¸ç¨€é‡Š</button>
            <button class="tab-button" onclick="switchTab(1)">JVç¨€é‡Š</button>
            <button class="tab-button" onclick="switchTab(2)">é€€å‡ºä¼°å€¼</button>
            <button class="tab-button" onclick="switchTab(3)">æŠ•å‰æŠ•åå¯¹æ¯”</button>
            <button class="tab-button" onclick="switchTab(4)">è‚¡æ¯”æ”¶ç›Šåˆ†æ</button>
        </div>
        
        <!-- Tab 1: æ¯å…¬å¸ç¨€é‡Š -->
        <div class="tab-content active">
            <div class="form-section">
                <h3>æ¯å…¬å¸è‚¡æƒç¨€é‡Šåˆ†æ - å®æ—¶è®¡ç®—è¡¨æ ¼</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    ä¿®æ”¹ä»»ä½•å•å…ƒæ ¼ï¼Œå…¶ä»–å€¼å°†è‡ªåŠ¨è®¡ç®—ã€‚å¯ä»¥è¾“å…¥æŠ•å‰ä¼°å€¼ã€æŠ•èµ„é¢ã€æŠ•åä¼°å€¼æˆ–è‚¡æƒæ¯”ä¾‹ä¸­çš„ä»»ä½•å€¼ã€‚
                </p>
                
                <div style="margin-bottom: 15px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label style="font-weight: 600; margin-right: 10px;">è®¡ç®—æ¨¡å¼ï¼š</label>
                        <select id="parent_calc_mode" onchange="changeCalcMode()" style="padding: 8px; border-radius: 5px; border: 2px solid #667eea;">
                            <option value="normal">æ ‡å‡†æ¨¡å¼ï¼ˆè¾“å…¥æŠ•å‰+æŠ•èµ„é¢ï¼‰</option>
                            <option value="post">è¾“å…¥æŠ•å+æŠ•èµ„é¢</option>
                            <option value="equity">è¾“å…¥æŠ•èµ„é¢+è‚¡æƒæ¯”ä¾‹</option>
                            <option value="flexible">çµæ´»æ¨¡å¼ï¼ˆä»»æ„è¾“å…¥ï¼‰</option>
                        </select>
                </div>
                    <div>
                        <label style="font-weight: 600; margin-right: 10px;">å¿«é€Ÿæ¨¡æ¿ï¼š</label>
                        <select id="template_select" onchange="loadTemplate()" style="padding: 8px; border-radius: 5px; border: 2px solid #28a745;">
                            <option value="">é€‰æ‹©æ¨¡æ¿...</option>
                            <option value="seed">ç§å­è½®ï¼ˆSeedï¼‰- ç®€å•åœºæ™¯</option>
                            <option value="seed_a">ç§å­è½® + Aè½®</option>
                            <option value="full_abc">å®Œæ•´èèµ„ï¼ˆA+B+Cè½®ï¼‰</option>
                            <option value="prea_a_b">Pre-A + Aè½® + Bè½®</option>
                            <option value="big_rounds">å¤§é¢èèµ„åœºæ™¯</option>
                            <option value="custom">è‡ªå®šä¹‰ï¼ˆæ¸…ç©ºè¡¨æ ¼ï¼‰</option>
                        </select>
                        </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">è¾“å…¥æ¨¡å¼ï¼š</label>
                        <select id="input_mode" onchange="changeInputMode()" style="padding: 8px; border-radius: 5px; border: 2px solid #667eea;">
                            <option value="manual">æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼ˆè‡ªç”±è®¾ç½®æ‰€æœ‰å€¼ï¼‰</option>
                            <option value="auto">è‡ªåŠ¨è®¡ç®—æ¨¡å¼ï¼ˆè¾“å…¥åè‡ªåŠ¨è®¡ç®—ï¼‰</option>
                        </select>
                        </div>
                    </div>
                
                <div style="overflow-x: auto;">
                    <table id="parent-dilution-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 12px; border: 1px solid #ddd;">è½®æ¬¡</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">
                                    æŠ•å‰ä¼°å€¼(ä¸‡å…ƒ)
                                    <small id="pre-money-label" style="display: block; font-size: 0.75em; opacity: 0.8;">å¯ç¼–è¾‘</small>
                                </th>
                                <th style="padding: 12px; border: 1px solid #ddd;">
                                    æŠ•èµ„é¢(ä¸‡å…ƒ)
                                    <small id="investment-label" style="display: block; font-size: 0.75em; opacity: 0.8;">å¯ç¼–è¾‘</small>
                                </th>
                                <th style="padding: 12px; border: 1px solid #ddd;">
                                    æŠ•åä¼°å€¼(ä¸‡å…ƒ)
                                    <small id="post-money-label" style="display: block; font-size: 0.75em; opacity: 0.8;">å¯ç¼–è¾‘</small>
                                </th>
                                <th style="padding: 12px; border: 1px solid #ddd;">
                                    æ–°æŠ•èµ„è€…è‚¡æƒ%
                                    <small id="investor-pct-label" style="display: block; font-size: 0.75em; opacity: 0.8;">å¯ç¼–è¾‘</small>
                                </th>
                                <th style="padding: 12px; border: 1px solid #ddd;">
                                    åˆ›å§‹äººæŒè‚¡%
                                    <small id="founder-pct-label" style="display: block; font-size: 0.75em; opacity: 0.8;">è‡ªåŠ¨</small>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="parent-dilution-tbody">
                            <!-- è¡Œ1: Seedè½® -->
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><input type="text" value="Seed" style="width: 100%; border: none; padding: 4px;"></td>
                                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                                    <input type="number" value="2000" class="pre-money" data-row="0" data-field="pre-money" style="width: 100%; border: none; padding: 4px; background: white;">
                                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                                </td>
                                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                                    <input type="number" value="500" class="investment" data-row="0" data-field="investment" style="width: 100%; border: none; padding: 4px; background: white;">
                                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                                </td>
                                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                                    <input type="number" value="2500" class="post-money" data-row="0" data-field="post-money" style="width: 100%; border: none; padding: 4px; background: #fff8dc;">
                                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                                </td>
                                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                                    <input type="number" value="20" class="investor-pct" data-row="0" data-field="investor-pct" style="width: 100%; border: none; padding: 4px; background: #fff8dc;">
                                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    <input type="number" value="80" class="founder-pct" data-row="0" readonly style="width: 100%; border: none; padding: 4px; background: #f0f0f0;">
                                </td>
                            </tr>
                            <!-- è¡Œ2: Aè½® -->
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><input type="text" value="A" style="width: 100%; border: none; padding: 4px;"></td>
                                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                                    <input type="number" value="2500" class="pre-money" data-row="1" data-field="pre-money" style="width: 100%; border: none; padding: 4px; background: white;">
                                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                                </td>
                                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                                    <input type="number" value="1500" class="investment" data-row="1" data-field="investment" style="width: 100%; border: none; padding: 4px; background: white;">
                                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                                </td>
                                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                                    <input type="number" value="4000" class="post-money" data-row="1" data-field="post-money" style="width: 100%; border: none; padding: 4px; background: #fff8dc;">
                                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                                </td>
                                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                                    <input type="number" value="37.5" class="investor-pct" data-row="1" data-field="investor-pct" style="width: 100%; border: none; padding: 4px; background: #fff8dc;">
                                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    <input type="number" value="50" class="founder-pct" data-row="1" readonly style="width: 100%; border: none; padding: 4px; background: #f0f0f0;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="addParentRow()">+ æ·»åŠ è½®æ¬¡</button>
                    <button class="btn btn-success" onclick="recalculateAllRows()" style="margin-left: 10px;">ğŸ”„ é‡æ–°è®¡ç®—</button>
                    <button class="btn" onclick="fillFromPrevousRow()" style="margin-left: 10px; background: #f0f0f0; color: #333;">ğŸ“‹ ä»ä¸Šä¸€è¡Œå¡«å……</button>
            </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
                    <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>å•å…ƒæ ¼é”å®š</strong>ï¼šæ¯ä¸ªå•å…ƒæ ¼å³ä¸Šè§’æœ‰ä¸ªğŸ”“å›¾æ ‡ï¼Œç‚¹å‡»å¯é”å®šè¯¥å•å…ƒæ ¼ï¼ˆå˜ğŸ”’å’Œçº¢è‰²èƒŒæ™¯ï¼‰</li>
                        <li><strong>é”å®šçŠ¶æ€</strong>ï¼šçº¢è‰²èƒŒæ™¯=å·²é”å®šï¼Œä¸ä¼šè¢«è®¡ç®—ï¼›é»„è‰²èƒŒæ™¯=è‡ªåŠ¨è®¡ç®—å­—æ®µï¼›ç™½è‰²=æ‰‹åŠ¨è¾“å…¥</li>
                        <li>ç‚¹å‡»<strong>"é‡æ–°è®¡ç®—"</strong>æŒ‰é’®ç»Ÿä¸€è®¡ç®—æ‰€æœ‰<strong>æœªé”å®š</strong>çš„å•å…ƒæ ¼</li>
                        <li>ç‚¹å‡»<strong>"ä»ä¸Šä¸€è¡Œå¡«å……"</strong>å¯æ‰¹é‡å¡«å……æŠ•å‰ä¼°å€¼</li>
                        <li>åˆ›å§‹äººæŒè‚¡è‡ªåŠ¨æŒ‰ç´¯ç§¯ç¨€é‡Šè®¡ç®—ï¼šä¸Šä¸€è½®åæŒè‚¡ Ã— (1 - æœ¬è½®æ–°æŠ•èµ„è€…è‚¡æƒ%)</li>
                    </ul>
                </div>
            </div>
            <div id="parent-results" class="results"></div>
        </div>
        
        <!-- Tab 2: JVç¨€é‡Š -->
        <div class="tab-content">
            <div class="form-section">
                <h3>åˆèµ„ä¼ä¸šè‚¡æƒç¨€é‡Šåˆ†æ</h3>
                <div class="form-group">
                    <label>åˆå§‹æŠ•èµ„ (ä¸‡å…ƒ)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <label style="font-size: 0.9em;">AgInno</label>
                            <input type="number" id="jv_ag_inno" value="100" step="10">
                        </div>
                        <div>
                            <label style="font-size: 0.9em;">Partner</label>
                            <input type="number" id="jv_partner" value="150" step="10">
                        </div>
                        <div>
                            <label style="font-size: 0.9em;">Grant</label>
                            <input type="number" id="jv_grant" value="0" step="10">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>èèµ„è½®æ¬¡</label>
                    <div id="jv-rounds">
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="A">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="500" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="B">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="1000" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="C">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="2000" step="100">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addRound('jv')">+ æ·»åŠ è½®æ¬¡</button>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeJV()">åˆ†æ</button>
            <div id="jv-results" class="results"></div>
        </div>
        
        <!-- Tab 3: é€€å‡ºä¼°å€¼ -->
        <div class="tab-content">
            <div class="form-section">
                <h3>é€€å‡ºä¼°å€¼ä¸é£é™©åˆ†æ</h3>
                <div class="form-group">
                    <label>æœªæ¥ç°é‡‘æµ (ä¸‡å…ƒ, ç”¨é€—å·åˆ†éš”)</label>
                    <input type="text" id="cash_flows" value="200,400,800,1200,1500">
                    <small style="color: #666;">ä¾‹å¦‚: 200,400,800,1200,1500</small>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>æŠ˜ç°ç‡</label>
                        <input type="number" id="discount_rate" value="0.12" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>æ°¸ç»­å¢é•¿ç‡</label>
                        <input type="number" id="growth_rate" value="0.03" step="0.01" min="0" max="0.1">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>æŠ•èµ„è€…æŒè‚¡æ¯”ä¾‹</label>
                        <input type="number" id="investor_share" value="0.2" step="0.1" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>æŠ•èµ„é‡‘é¢ (ä¸‡å…ƒ)</label>
                        <input type="number" id="invested_amount" value="1500" step="100">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="run_montecarlo" checked>
                        è¿è¡Œè’™ç‰¹å¡æ´›é£é™©åˆ†æ
                    </label>
                    <div style="margin-top: 10px;">
                        <label>æ¨¡æ‹Ÿæ¬¡æ•°</label>
                        <input type="number" id="montecarlo_trials" value="10000" step="1000">
                        <label>ç°é‡‘æµæ³¢åŠ¨ç‡</label>
                        <input type="number" id="cf_volatility" value="0.2" step="0.1">
                    </div>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeExit()">åˆ†æ</button>
            <div id="exit-results" class="results"></div>
        </div>

        <!-- Tab 4: æŠ•å‰æŠ•åå¯¹æ¯” -->
        <div class="tab-content">
            <div class="form-section">
                <h3>æŠ•å‰/æŠ•åä¼°å€¼å¯¹æ¯”åˆ†æ</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>æŠ•å‰ä¼°å€¼ (ä¸‡å…ƒ)</label>
                        <input type="number" id="pre_money_valuation" value="2000" step="100" min="1">
                    </div>
                    <div class="form-group">
                        <label>æŠ•åä¼°å€¼ (ä¸‡å…ƒ)</label>
                        <input type="number" id="post_money_valuation" value="5000" step="100" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>æŠ•èµ„è½®æ¬¡</label>
                    <div id="valuation-rounds">
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="Seed">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="500" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="Aè½®">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="1500" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="Bè½®">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="1000" step="100">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addRound('valuation')">+ æ·»åŠ è½®æ¬¡</button>
                </div>

                <div class="form-group">
                    <label>åˆä¼™äººè‚¡æƒåˆ†é…</label>
                    <div id="partner-equity-splits">
                        <div class="round-item">
                            <input type="text" placeholder="åˆä¼™äººå§“å" value="åˆ›å§‹äººA">
                            <input type="number" placeholder="è‚¡æƒæ¯”ä¾‹(0-1)" value="0.4" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="åˆä¼™äººå§“å" value="åˆ›å§‹äººB">
                            <input type="number" placeholder="è‚¡æƒæ¯”ä¾‹(0-1)" value="0.3" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="åˆä¼™äººå§“å" value="æ—©æœŸå‘˜å·¥">
                            <input type="number" placeholder="è‚¡æƒæ¯”ä¾‹(0-1)" value="0.2" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="åˆä¼™äººå§“å" value="æŠ•èµ„äºº">
                            <input type="number" placeholder="è‚¡æƒæ¯”ä¾‹(0-1)" value="0.1" step="0.01" min="0" max="1">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addPartner('partner-equity-splits')">+ æ·»åŠ åˆä¼™äºº</button>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeValuationComparison()">åˆ†æ</button>
            <div id="valuation-results" class="results"></div>
        </div>

        <!-- Tab 5: è‚¡æ¯”æ”¶ç›Šåˆ†æ -->
        <div class="tab-content">
            <div class="form-section">
                <h3>å¤šè½®æ¬¡è‚¡æ¯”å’Œæ”¶ç›Šåˆ†æ</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>åˆå§‹ä¼°å€¼ (ä¸‡å…ƒ)</label>
                        <input type="number" id="initial_valuation" value="1000" step="100" min="1">
                    </div>
                    <div class="form-group">
                        <label>é€€å‡ºæ—¶ä¼°å€¼ (ä¸‡å…ƒ)</label>
                        <input type="number" id="exit_valuation" value="10000" step="100" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>åˆå§‹åˆä¼™äººåŠå…¶è‚¡æƒæ¯”ä¾‹</label>
                    <div id="initial-partners">
                        <div class="round-item">
                            <input type="text" placeholder="åˆä¼™äººå§“å" value="åˆ›å§‹äººA">
                            <input type="number" placeholder="è‚¡æƒæ¯”ä¾‹(0-1)" value="0.5" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="åˆä¼™äººå§“å" value="åˆ›å§‹äººB">
                            <input type="number" placeholder="è‚¡æƒæ¯”ä¾‹(0-1)" value="0.3" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="åˆä¼™äººå§“å" value="æ—©æœŸæŠ•èµ„äºº">
                            <input type="number" placeholder="è‚¡æƒæ¯”ä¾‹(0-1)" value="0.2" step="0.01" min="0" max="1">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addPartner('initial-partners')">+ æ·»åŠ åˆä¼™äºº</button>
                </div>

                <div class="form-group">
                    <label>æŠ•èµ„è½®æ¬¡</label>
                    <div id="equity-rounds">
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="Aè½®">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="1000" step="100">
                            <input type="number" placeholder="æ–°æŠ•èµ„è€…è‚¡æƒæ¯”ä¾‹(0-1)" value="0.15" step="0.01" min="0" max="1" title="æ–°æŠ•èµ„è€…è·å¾—çš„å…·ä½“è‚¡æƒæ¯”ä¾‹">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="Bè½®">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="3000" step="100">
                            <input type="number" placeholder="æ–°æŠ•èµ„è€…è‚¡æƒæ¯”ä¾‹(0-1)" value="0.2" step="0.01" min="0" max="1" title="æ–°æŠ•èµ„è€…è·å¾—çš„å…·ä½“è‚¡æƒæ¯”ä¾‹">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="è½®æ¬¡åç§°" value="Cè½®">
                            <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="5000" step="100">
                            <input type="number" placeholder="æ–°æŠ•èµ„è€…è‚¡æƒæ¯”ä¾‹(0-1)" value="0.25" step="0.01" min="0" max="1" title="æ–°æŠ•èµ„è€…è·å¾—çš„å…·ä½“è‚¡æƒæ¯”ä¾‹">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addEquityRound('equity-rounds')">+ æ·»åŠ è½®æ¬¡</button>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeEquityReturns()">åˆ†æ</button>
            <div id="equity-results" class="results"></div>
        </div>

        <div class="loading" id="loading">
            ğŸ”„ æ­£åœ¨åˆ†æä¸­...
        </div>
    </div>
    
    <script>
        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.switchTab = function(index) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            buttons.forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        };

        window.addRound = function(type) {
            const roundsDiv = document.getElementById(type + '-rounds');
            const newRound = document.createElement('div');
            newRound.className = 'round-item';
            newRound.innerHTML = `
                <input type="text" placeholder="è½®æ¬¡åç§°">
                <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="0" step="100">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
            `;
            roundsDiv.appendChild(newRound);
        };

        // åŠ è½½æ¨¡æ¿
        window.loadTemplate = function() {
            const template = document.getElementById('template_select').value;
            if (!template || template === 'custom') {
                if (template === 'custom') {
                    // æ¸…ç©ºè¡¨æ ¼ï¼Œåªä¿ç•™ä¸€è¡Œ
                    const tbody = document.getElementById('parent-dilution-tbody');
                    const firstRow = tbody.querySelector('tr');
                    if (firstRow) {
                        tbody.innerHTML = '';
                        tbody.appendChild(firstRow.cloneNode(true));
                        // é‡ç½®ç¬¬ä¸€è¡Œæ•°æ®
                        const inputs = tbody.querySelectorAll('tr input');
                        if (inputs.length >= 5) {
                            inputs[0].value = 'Round1'; // è½®æ¬¡
                            inputs[1].value = '0';      // æŠ•å‰
                            inputs[2].value = '0';      // æŠ•èµ„é¢
                            inputs[3].value = '0';      // æŠ•å
                            inputs[4].value = '0';      // æ–°æŠ•èµ„è€…è‚¡æƒ%
                            inputs[5].value = '100';   // åˆ›å§‹äººæŒè‚¡%
                        }
                    }
                    changeCalcMode();
                }
                return;
            }
            
            const templates = {
                'seed': [
                    { round: 'Seed', pre: 1000, invest: 200, post: 1200, invPct: 16.67, founderPct: 83.33 }
                ],
                'seed_a': [
                    { round: 'Seed', pre: 1500, invest: 500, post: 2000, invPct: 25, founderPct: 75 },
                    { round: 'A', pre: 2000, invest: 1000, post: 3000, invPct: 33.33, founderPct: 50 }
                ],
                'full_abc': [
                    { round: 'Aè½®', pre: 2000, invest: 800, post: 2800, invPct: 28.57, founderPct: 71.43 },
                    { round: 'Bè½®', pre: 2800, invest: 2000, post: 4800, invPct: 41.67, founderPct: 41.67 },
                    { round: 'Cè½®', pre: 4800, invest: 5000, post: 9800, invPct: 51.02, founderPct: 20.41 }
                ],
                'prea_a_b': [
                    { round: 'Pre-A', pre: 1000, invest: 300, post: 1300, invPct: 23.08, founderPct: 76.92 },
                    { round: 'Aè½®', pre: 1300, invest: 700, post: 2000, invPct: 35, founderPct: 50.00 },
                    { round: 'Bè½®', pre: 2000, invest: 2000, post: 4000, invPct: 50, founderPct: 25.00 }
                ],
                'big_rounds': [
                    { round: 'Aè½®', pre: 5000, invest: 2000, post: 7000, invPct: 28.57, founderPct: 71.43 },
                    { round: 'Bè½®', pre: 7000, invest: 5000, post: 12000, invPct: 41.67, founderPct: 41.67 },
                    { round: 'Cè½®', pre: 12000, invest: 8000, post: 20000, invPct: 40, founderPct: 25.00 },
                    { round: 'Dè½®', pre: 20000, invest: 15000, post: 35000, invPct: 42.86, founderPct: 14.29 }
                ]
            };
            
            const data = templates[template];
            if (!data) return;
            
            // æ¸…ç©ºç°æœ‰æ•°æ®å’Œé”å®šçŠ¶æ€
            const tbody = document.getElementById('parent-dilution-tbody');
            tbody.innerHTML = '';
            lockedCells = {}; // æ¸…ç©ºé”å®šçŠ¶æ€
            
            // æ·»åŠ æ¨¡æ¿æ•°æ®
            data.forEach((rowData, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd;"><input type="text" value="${rowData.round}" style="width: 100%; border: none; padding: 4px;"></td>
                    <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                        <input type="number" value="${rowData.pre}" class="pre-money" data-row="${index}" data-field="pre-money" style="width: 100%; border: none; padding: 4px; background: white;">
                        <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                    </td>
                    <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                        <input type="number" value="${rowData.invest}" class="investment" data-row="${index}" data-field="investment" style="width: 100%; border: none; padding: 4px; background: white;">
                        <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                    </td>
                    <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                        <input type="number" value="${rowData.post}" class="post-money" data-row="${index}" data-field="post-money" style="width: 100%; border: none; padding: 4px; background: #fff8dc;">
                        <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                    </td>
                    <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                        <input type="number" value="${rowData.invPct.toFixed(2)}" class="investor-pct" data-row="${index}" data-field="investor-pct" style="width: 100%; border: none; padding: 4px; background: #fff8dc;">
                        <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="number" value="${rowData.founderPct.toFixed(2)}" class="founder-pct" data-row="${index}" readonly style="width: 100%; border: none; padding: 4px; background: #f0f0f0;">
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // é‡æ–°åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initParentDilutionTable();
            
            // åº”ç”¨å½“å‰è®¡ç®—æ¨¡å¼
            changeCalcMode();
            
            // é‡ç½®æ¨¡æ¿é€‰æ‹©å™¨
            document.getElementById('template_select').value = '';
        };

        // åˆ‡æ¢è®¡ç®—æ¨¡å¼
        window.changeCalcMode = function() {
            const mode = document.getElementById('parent_calc_mode').value;
            const tbody = document.getElementById('parent-dilution-tbody');
            if (!tbody) return;
            
            // æ›´æ–°æ ‡ç­¾
            if (mode === 'normal') {
                // æ ‡å‡†æ¨¡å¼ï¼šè¾“å…¥æŠ•å‰+æŠ•èµ„é¢
                document.getElementById('pre-money-label').textContent = '[è¾“å…¥]';
                document.getElementById('investment-label').textContent = '[è¾“å…¥]';
                document.getElementById('post-money-label').textContent = '[è‡ªåŠ¨]';
                document.getElementById('investor-pct-label').textContent = '[è‡ªåŠ¨]';
                document.getElementById('founder-pct-label').textContent = '[è‡ªåŠ¨]';
                
                // è®¾ç½®readonly
                tbody.querySelectorAll('.pre-money').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.investment').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.post-money').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
                tbody.querySelectorAll('.investor-pct').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
                tbody.querySelectorAll('.founder-pct').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
            } else if (mode === 'post') {
                // è¾“å…¥æŠ•å+æŠ•èµ„é¢
                document.getElementById('pre-money-label').textContent = '[è‡ªåŠ¨]';
                document.getElementById('investment-label').textContent = '[è¾“å…¥]';
                document.getElementById('post-money-label').textContent = '[è¾“å…¥]';
                document.getElementById('investor-pct-label').textContent = '[è‡ªåŠ¨]';
                document.getElementById('founder-pct-label').textContent = '[è‡ªåŠ¨]';
                
                tbody.querySelectorAll('.pre-money').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
                tbody.querySelectorAll('.investment').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.post-money').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.investor-pct').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
                tbody.querySelectorAll('.founder-pct').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
            } else if (mode === 'equity') {
                // è¾“å…¥æŠ•èµ„é¢+è‚¡æƒæ¯”ä¾‹
                document.getElementById('pre-money-label').textContent = '[è‡ªåŠ¨]';
                document.getElementById('investment-label').textContent = '[è¾“å…¥]';
                document.getElementById('post-money-label').textContent = '[è‡ªåŠ¨]';
                document.getElementById('investor-pct-label').textContent = '[è¾“å…¥]';
                document.getElementById('founder-pct-label').textContent = '[è‡ªåŠ¨]';
                
                tbody.querySelectorAll('.pre-money').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
                tbody.querySelectorAll('.investment').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.post-money').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
                tbody.querySelectorAll('.investor-pct').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.founder-pct').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
            } else {
                // çµæ´»æ¨¡å¼ï¼šå…¨éƒ¨å¯ç¼–è¾‘
                document.getElementById('pre-money-label').textContent = '[è¾“å…¥]';
                document.getElementById('investment-label').textContent = '[è¾“å…¥]';
                document.getElementById('post-money-label').textContent = '[è¾“å…¥]';
                document.getElementById('investor-pct-label').textContent = '[è¾“å…¥]';
                document.getElementById('founder-pct-label').textContent = '[è‡ªåŠ¨]';
                
                tbody.querySelectorAll('.pre-money').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.investment').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.post-money').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.investor-pct').forEach(input => {
                    input.readOnly = false;
                    input.style.background = 'white';
                });
                tbody.querySelectorAll('.founder-pct').forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                });
            }
            
            // é‡æ–°è®¡ç®—æ‰€æœ‰è¡Œ
            recalculateAllRows();
        };

        // æ·»åŠ åˆä¼™äºº
        window.addPartner = function(containerId) {
            const container = document.getElementById(containerId);
            const newPartner = document.createElement('div');
            newPartner.className = 'round-item';
            newPartner.innerHTML = `
                <input type="text" placeholder="åˆä¼™äººå§“å">
                <input type="number" placeholder="è‚¡æƒæ¯”ä¾‹(0-1)" value="0" step="0.01" min="0" max="1">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
            `;
            container.appendChild(newPartner);
        };

        // æ·»åŠ è‚¡æ¯”è½®æ¬¡ï¼ˆå¸¦è‚¡æƒæ¯”ä¾‹è¾“å…¥ï¼‰
        window.addEquityRound = function(containerId) {
            const container = document.getElementById(containerId);
            const newRound = document.createElement('div');
            newRound.className = 'round-item';
            newRound.innerHTML = `
                <input type="text" placeholder="è½®æ¬¡åç§°" style="flex: 1.5;">
                <input type="number" placeholder="æŠ•èµ„é¢(ä¸‡å…ƒ)" value="0" step="100" style="flex: 1;">
                <input type="number" placeholder="æ–°æŠ•èµ„è€…è‚¡æƒæ¯”ä¾‹(0-1)" value="0" step="0.01" min="0" max="1" style="flex: 1;" title="æ–°æŠ•èµ„è€…è·å¾—çš„å…·ä½“è‚¡æƒæ¯”ä¾‹">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
            `;
            container.appendChild(newRound);
        };

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // æ¯å…¬å¸ç¨€é‡Šåˆ†æï¼ˆæ–°è¡¨æ ¼ç‰ˆæœ¬ï¼‰
        window.analyzeParent = async function() {
            // å…¼å®¹æ—§ç‰ˆæœ¬çš„è°ƒç”¨ï¼Œç°åœ¨å§”æ‰˜ç»™æ–°å‡½æ•°
            return analyzeParentFromTable();
        }

        // æ˜¾ç¤ºæ¯å…¬å¸ç»“æœ
        function displayParentResults(data) {
            const resultsDiv = document.getElementById('parent-results');
            
            let html = '<div class="result-card"><h4>åˆ†æç»“æœ</h4>';
            html += `<div class="stats-grid">
                <div class="stat-card">
                    <h5>æœ€ç»ˆåˆ›å§‹äººæŒè‚¡</h5>
                    <div class="value">${data.final_dilution.toFixed(2)}%</div>
                </div>
            </div>`;
            
            // è¡¨æ ¼
            html += '<table><thead><tr><th>è½®æ¬¡</th><th>æŠ•å‰ä¼°å€¼</th><th>æŠ•èµ„é¢</th><th>æŠ•åä¼°å€¼</th><th>åˆ›å§‹äººæŒè‚¡</th><th>æ–°æŠ•èµ„è€…æŒè‚¡</th></tr></thead><tbody>';
            
            data.data.forEach(row => {
                html += `<tr>
                    <td>${row.round}</td>
                    <td>${row.pre_money.toFixed(0)}ä¸‡</td>
                    <td>${row.investment.toFixed(0)}ä¸‡</td>
                    <td>${row.post_money.toFixed(0)}ä¸‡</td>
                    <td>${(row.founders_pct * 100).toFixed(2)}%</td>
                    <td>${(row.new_investor_pct * 100).toFixed(2)}%</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // å›¾è¡¨
            html += '<div class="chart-container"><canvas id="parentChart"></canvas></div>';
            
            resultsDiv.innerHTML = html;
            
            // ç»˜åˆ¶å›¾è¡¨
            setTimeout(() => {
                const ctx = document.getElementById('parentChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(r => r.round),
                        datasets: [{
                            label: 'åˆ›å§‹äººæŒè‚¡æ¯”ä¾‹',
                            data: data.data.map(r => r.founders_pct * 100),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'è‚¡æƒç¨€é‡Šè¶‹åŠ¿' }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { suffix: '%' } }
                        }
                    }
                });
            }, 100);
        };

        // JVç¨€é‡Šåˆ†æ
        window.analyzeJV = async function() {
            showLoading();
            
            try {
                const initialInv = {
                    ag_inno: parseFloat(document.getElementById('jv_ag_inno').value),
                    partner: parseFloat(document.getElementById('jv_partner').value),
                    grant: parseFloat(document.getElementById('jv_grant').value)
                };
                
                const rounds = Array.from(document.querySelectorAll('#jv-rounds .round-item')).map(item => {
                    const inputs = item.querySelectorAll('input');
                    return {
                        round: inputs[0].value || 'Round',
                        amount: parseFloat(inputs[1].value)
                    };
                });
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jv_dilution: { initial_investments: initialInv, rounds: rounds }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayJVResults(data.results.jv_dilution);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºJVç»“æœ
        function displayJVResults(data) {
            const resultsDiv = document.getElementById('jv-results');
            
            const final = data.final_ownership;
            
            let html = '<div class="result-card"><h4>åˆ†æç»“æœ</h4>';
            html += `<div class="stats-grid">
                <div class="stat-card">
                    <h5>AgInnoæŒè‚¡</h5>
                    <div class="value">${(final.ag_inno_pct * 100).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h5>PartneræŒè‚¡</h5>
                    <div class="value">${(final.partner_pct * 100).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h5>GrantæŒè‚¡</h5>
                    <div class="value">${(final.grant_pct * 100).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h5>å¤–éƒ¨æŠ•èµ„è€…</h5>
                    <div class="value">${(final.external_pct * 100).toFixed(2)}%</div>
                </div>
            </div>`;
            
            // è¡¨æ ¼
            html += '<table><thead><tr><th>è½®æ¬¡</th><th>æŠ•å‰ä¼°å€¼</th><th>æŠ•èµ„é¢</th><th>æŠ•åä¼°å€¼</th><th>AgInno</th><th>Partner</th><th>Grant</th><th>å¤–éƒ¨</th></tr></thead><tbody>';
            
            data.data.forEach(row => {
                html += `<tr>
                    <td>${row.round}</td>
                    <td>${row.pre_money.toFixed(0)}ä¸‡</td>
                    <td>${row.investment.toFixed(0)}ä¸‡</td>
                    <td>${row.post_money.toFixed(0)}ä¸‡</td>
                    <td>${(row.ag_inno_pct * 100).toFixed(2)}%</td>
                    <td>${(row.partner_pct * 100).toFixed(2)}%</td>
                    <td>${(row.grant_pct * 100).toFixed(2)}%</td>
                    <td>${(row.external_pct * 100).toFixed(2)}%</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // å›¾è¡¨
            html += '<div class="chart-container"><canvas id="jvChart"></canvas></div>';
            
            resultsDiv.innerHTML = html;
            
            // ç»˜åˆ¶å›¾è¡¨
            setTimeout(() => {
                const ctx = document.getElementById('jvChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(r => r.round),
                        datasets: [
                            { label: 'AgInno', data: data.data.map(r => r.ag_inno_pct * 100), borderColor: '#28a745', tension: 0.4 },
                            { label: 'Partner', data: data.data.map(r => r.partner_pct * 100), borderColor: '#17a2b8', tension: 0.4 },
                            { label: 'Grant', data: data.data.map(r => r.grant_pct * 100), borderColor: '#ffc107', tension: 0.4 },
                            { label: 'å¤–éƒ¨æŠ•èµ„è€…', data: data.data.map(r => r.external_pct * 100), borderColor: '#dc3545', tension: 0.4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'JVè‚¡æƒç¨€é‡Šè¶‹åŠ¿' } },
                        scales: { y: { beginAtZero: true, ticks: { suffix: '%' } } }
                    }
                });
            }, 100);
        };

        // é€€å‡ºä¼°å€¼åˆ†æ
        window.analyzeExit = async function() {
            showLoading();
            
            try {
                const cashFlows = document.getElementById('cash_flows').value.split(',').map(x => parseFloat(x.trim()));
                const discountRate = parseFloat(document.getElementById('discount_rate').value);
                const growthRate = parseFloat(document.getElementById('growth_rate').value);
                const investorShare = parseFloat(document.getElementById('investor_share').value);
                const investedAmount = parseFloat(document.getElementById('invested_amount').value);
                const runMC = document.getElementById('run_montecarlo').checked;
                const mcTrials = parseInt(document.getElementById('montecarlo_trials').value);
                const cfVolatility = parseFloat(document.getElementById('cf_volatility').value);
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        exit_analysis: {
                            cash_flows: cashFlows,
                            discount_rate: discountRate,
                            growth_rate: growthRate,
                            investor_share: investorShare,
                            invested_amount: investedAmount
                        },
                        run_montecarlo: runMC,
                        montecarlo_trials: mcTrials,
                        cf_volatility: cfVolatility
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayExitResults(data.results);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºé€€å‡ºåˆ†æç»“æœ
        function displayExitResults(results) {
            const resultsDiv = document.getElementById('exit-results');
            
            const exit = results.exit_analysis;
            
            let html = '<div class="result-card"><h4>DCFä¼°å€¼ç»“æœ</h4>';
            html += `<div class="stats-grid">
                <div class="stat-card">
                    <h5>ç°é‡‘æµç°å€¼</h5>
                    <div class="value">${exit.pv_cashflows.toFixed(0)}ä¸‡</div>
                </div>
                <div class="stat-card">
                    <h5>ç»ˆå€¼</h5>
                    <div class="value">${exit.terminal_value.toFixed(0)}ä¸‡</div>
                </div>
                <div class="stat-card">
                    <h5>é€€å‡ºä¼°å€¼</h5>
                    <div class="value">${exit.exit_valuation.toFixed(0)}ä¸‡</div>
                </div>
                <div class="stat-card">
                    <h5>æŠ•èµ„å›æŠ¥ç‡</h5>
                    <div class="value">${(exit.investor_roi * 100).toFixed(2)}%</div>
                </div>
            </div></div>`;
            
            // è’™ç‰¹å¡æ´›ç»“æœ
            if (results.montecarlo) {
                const mc = results.montecarlo;
                html += '<div class="result-card"><h4>è’™ç‰¹å¡æ´›é£é™©åˆ†æ</h4>';
                html += '<p>æ¨¡æ‹Ÿæ¬¡æ•°: ' + mc.trials_count + '</p>';
                html += '<div class="stats-grid">';
                html += '<div class="stat-card"><h5>ä¼°å€¼å‡å€¼</h5><div class="value">' + mc.mean_exit_value.toFixed(0) + 'ä¸‡</div></div>';
                html += '<div class="stat-card"><h5>ä¼°å€¼ä¸­ä½æ•°</h5><div class="value">' + mc.median_exit_value.toFixed(0) + 'ä¸‡</div></div>';
                html += '<div class="stat-card"><h5>ä¼°å€¼10%åˆ†ä½</h5><div class="value">' + mc.p10_exit_value.toFixed(0) + 'ä¸‡</div></div>';
                html += '<div class="stat-card"><h5>ä¼°å€¼90%åˆ†ä½</h5><div class="value">' + mc.p90_exit_value.toFixed(0) + 'ä¸‡</div></div>';
                html += '<div class="stat-card"><h5>ROIå‡å€¼</h5><div class="value">' + (mc.mean_roi * 100).toFixed(2) + '%</div></div>';
                html += '<div class="stat-card"><h5>ROIä¸­ä½æ•°</h5><div class="value">' + (mc.median_roi * 100).toFixed(2) + '%</div></div>';
                html += '<div class="stat-card"><h5>ROI 10%åˆ†ä½</h5><div class="value">' + (mc.p10_roi * 100).toFixed(2) + '%</div></div>';
                html += '<div class="stat-card"><h5>ROI 90%åˆ†ä½</h5><div class="value">' + (mc.p90_roi * 100).toFixed(2) + '%</div></div>';
                html += '</div></div>';
            }
            
            resultsDiv.innerHTML = html;
        };

        // æŠ•å‰æŠ•åä¼°å€¼å¯¹æ¯”åˆ†æ
        window.analyzeValuationComparison = async function() {
            showLoading();

            try {
                const preMoney = parseFloat(document.getElementById('pre_money_valuation').value);
                const postMoney = parseFloat(document.getElementById('post_money_valuation').value);

                const rounds = Array.from(document.querySelectorAll('#valuation-rounds .round-item')).map(item => {
                    const inputs = item.querySelectorAll('input');
                    return {
                        round: inputs[0].value || 'Round',
                        amount: parseFloat(inputs[1].value)
                    };
                });

                const partnerSplits = {};
                Array.from(document.querySelectorAll('#partner-equity-splits .round-item')).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const name = inputs[0].value;
                    const equity = parseFloat(inputs[1].value);
                    if (name && equity > 0) {
                        partnerSplits[name] = equity;
                    }
                });

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        valuation_comparison: {
                            pre_money: preMoney,
                            post_money: postMoney,
                            investment_rounds: rounds,
                            partner_equity_splits: partnerSplits
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayValuationComparisonResults(data.results.valuation_comparison);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºæŠ•å‰æŠ•åå¯¹æ¯”ç»“æœ
        function displayValuationComparisonResults(data) {
            const resultsDiv = document.getElementById('valuation-results');

            let html = '<div class="result-card"><h4>æŠ•å‰/æŠ•åä¼°å€¼å¯¹æ¯”åˆ†æ</h4>';

            // æ ¸å¿ƒæŒ‡æ ‡
            html += '<div class="stats-grid">';
            html += `<div class="stat-card">
                <h5>æŠ•å‰ä¼°å€¼</h5>
                <div class="value">${data.data.pre_money_valuation.toFixed(0)}ä¸‡</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>æŠ•åä¼°å€¼</h5>
                <div class="value">${data.data.post_money_valuation.toFixed(0)}ä¸‡</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>ä¼°å€¼å€æ•°</h5>
                <div class="value">${data.data.valuation_multiple.toFixed(2)}å€</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>æŠ•èµ„ROI</h5>
                <div class="value">${data.data.investor_roi_percentage.toFixed(2)}%</div>
            </div>`;
            html += '</div>';

            // è¯¦ç»†è¡¨æ ¼
            html += '<h5 style="margin-top: 30px; color: #333;">è¯¦ç»†åˆ†æç»“æœ</h5>';
            html += '<table><thead><tr><th>é¡¹ç›®</th><th>æ•°å€¼</th><th>å•ä½</th><th>è¯´æ˜</th></tr></thead><tbody>';

            data.table.forEach(row => {
                html += `<tr>
                    <td>${row.é¡¹ç›®}</td>
                    <td>${typeof row.æ•°å€¼ === 'number' ? row.æ•°å€¼.toFixed(2) : row.æ•°å€¼}</td>
                    <td>${row.å•ä½}</td>
                    <td>${row.è¯´æ˜}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            // åˆä¼™äººæ”¶ç›Šå›¾è¡¨
            const partners = data.data.partner_returns;
            if (Object.keys(partners).length > 0) {
                html += '<div class="chart-container"><canvas id="valuationChart"></canvas></div>';

                resultsDiv.innerHTML = html;

                // ç»˜åˆ¶åˆä¼™äººæ”¶ç›Šå›¾è¡¨
                setTimeout(() => {
                    const ctx = document.getElementById('valuationChart').getContext('2d');
                    const labels = Object.keys(partners);
                    const returnData = labels.map(p => partners[p].return_amount);

                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'æ”¶ç›Šåˆ†é…',
                                data: returnData,
                                backgroundColor: [
                                    '#667eea', '#764ba2', '#f093fb', '#f5576c',
                                    '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'åˆä¼™äººæ”¶ç›Šåˆ†é…' },
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }, 100);
            } else {
                resultsDiv.innerHTML = html;
            }
        }

        // è‚¡æ¯”æ”¶ç›Šåˆ†æ
        window.analyzeEquityReturns = async function() {
            showLoading();

            try {
                const initialValuation = parseFloat(document.getElementById('initial_valuation').value);
                const exitValuation = parseFloat(document.getElementById('exit_valuation').value);

                const initialPartners = {};
                Array.from(document.querySelectorAll('#initial-partners .round-item')).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const name = inputs[0].value;
                    const equity = parseFloat(inputs[1].value);
                    if (name && equity > 0) {
                        initialPartners[name] = equity;
                    }
                });

                const rounds = Array.from(document.querySelectorAll('#equity-rounds .round-item')).map(item => {
                    const inputs = item.querySelectorAll('input');
                    return {
                        round: inputs[0].value || 'Round',
                        amount: parseFloat(inputs[1].value)
                    };
                });

                const newInvestorsPerRound = {};
                Array.from(document.querySelectorAll('#equity-rounds .round-item')).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const roundName = inputs[0].value;
                    const equityRatio = parseFloat(inputs[2].value);
                    if (roundName && equityRatio > 0) {
                        newInvestorsPerRound[roundName] = equityRatio;
                    }
                });

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        equity_returns: {
                            initial_valuation: initialValuation,
                            investment_rounds: rounds,
                            initial_partners: initialPartners,
                            new_investors_per_round: newInvestorsPerRound
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayEquityReturnsResults(data.results.equity_returns);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºè‚¡æ¯”æ”¶ç›Šåˆ†æç»“æœ
        function displayEquityReturnsResults(data) {
            const resultsDiv = document.getElementById('equity-results');

            let html = '<div class="result-card"><h4>å¤šè½®æ¬¡è‚¡æ¯”å’Œæ”¶ç›Šåˆ†æ</h4>';

            // æ ¸å¿ƒæŒ‡æ ‡
            html += '<div class="stats-grid">';
            html += `<div class="stat-card">
                <h5>æ€»æŠ•èµ„é¢</h5>
                <div class="value">${data.data.total_investment.toFixed(0)}ä¸‡</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>é€€å‡ºä¼°å€¼</h5>
                <div class="value">${data.data.exit_valuation.toFixed(0)}ä¸‡</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>æ€»æ”¶ç›Š</h5>
                <div class="value">${data.data.total_return.toFixed(0)}ä¸‡</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>æ•´ä½“ROI</h5>
                <div class="value">${data.data.roi_percentage.toFixed(2)}%</div>
            </div>`;
            html += '</div>';

            // è¯¦ç»†è¡¨æ ¼
            html += '<h5 style="margin-top: 30px; color: #333;">è¯¦ç»†æ”¶ç›Šåˆ†æ</h5>';
            html += '<table><thead><tr><th>é¡¹ç›®</th><th>æ•°å€¼</th><th>å•ä½</th><th>è¯´æ˜</th></tr></thead><tbody>';

            data.table.forEach(row => {
                html += `<tr>
                    <td>${row.é¡¹ç›®}</td>
                    <td>${typeof row.æ•°å€¼ === 'number' ? row.æ•°å€¼.toFixed(2) : row.æ•°å€¼}</td>
                    <td>${row.å•ä½}</td>
                    <td>${row.è¯´æ˜}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            // æ¨¡æ‹Ÿè¿‡ç¨‹è¡¨æ ¼
            if (data.data.simulation_data && data.data.simulation_data.length > 0) {
                html += '<div class="result-card"><h4>èèµ„è¿‡ç¨‹æ¨¡æ‹Ÿ</h4>';
                html += '<table><thead><tr><th>è½®æ¬¡</th><th>æŠ•èµ„é¢</th><th>æŠ•å‰ä¼°å€¼</th><th>æŠ•åä¼°å€¼</th><th>æ–°æŠ•èµ„è€…è‚¡æƒ</th>';

                // è·å–æ‰€æœ‰åˆä¼™äººåç§°
                const partners = Object.keys(data.data.final_equity_distribution);
                partners.forEach(partner => {
                    html += `<th>${partner}è‚¡æƒ</th>`;
                });

                html += '</tr></thead><tbody>';

                data.data.simulation_data.forEach(row => {
                    html += `<tr>
                        <td>${row.è½®æ¬¡}</td>
                        <td>${row.æŠ•èµ„é¢.toFixed(0)}ä¸‡</td>
                        <td>${row.æŠ•å‰ä¼°å€¼.toFixed(0)}ä¸‡</td>
                        <td>${row.æŠ•åä¼°å€¼.toFixed(0)}ä¸‡</td>
                        <td>${row.æ–°æŠ•èµ„è€…è‚¡æƒ.toFixed(2)}%</td>`;

                    partners.forEach(partner => {
                        const equityKey = `${partner}_è‚¡æƒ`;
                        const equity = row[equityKey] || 0;
                        html += `<td>${equity.toFixed(2)}%</td>`;
                    });

                    html += '</tr>';
                });

                html += '</tbody></table></div>';
            }

            // æœ€ç»ˆè‚¡æƒåˆ†å¸ƒå›¾è¡¨
            const finalEquity = data.data.final_equity_distribution;
            if (Object.keys(finalEquity).length > 0) {
                html += '<div class="chart-container"><canvas id="equityChart"></canvas></div>';

                resultsDiv.innerHTML = html;

                // ç»˜åˆ¶æœ€ç»ˆè‚¡æƒåˆ†å¸ƒå›¾è¡¨
                setTimeout(() => {
                    const ctx = document.getElementById('equityChart').getContext('2d');
                    const labels = Object.keys(finalEquity);
                    const equityData = labels.map(p => finalEquity[p] * 100);

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'æœ€ç»ˆè‚¡æƒæ¯”ä¾‹',
                                data: equityData,
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: '#667eea',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'æœ€ç»ˆè‚¡æƒåˆ†å¸ƒ' },
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { suffix: '%' }
                                }
                            }
                        }
                    });
                }, 100);
            } else {
                resultsDiv.innerHTML = html;
            }
        }

        // æ¯å…¬å¸ç¨€é‡Šè¡¨æ ¼è®¡ç®—ï¼ˆæ‰‹åŠ¨è§¦å‘æ¨¡å¼ï¼‰
        let autoCalculateEnabled = false; // é»˜è®¤å…³é—­è‡ªåŠ¨è®¡ç®—ï¼Œåªé€šè¿‡æŒ‰é’®è§¦å‘

        window.initParentDilutionTable = function() {
            const tbody = document.getElementById('parent-dilution-tbody');
            if (!tbody) return;
            
            // åˆå§‹åŒ–è¡¨æ ¼ï¼Œä½†ä¸æ·»åŠ è‡ªåŠ¨è®¡ç®—ç›‘å¬å™¨
            // ç”¨æˆ·éœ€è¦ç‚¹å‡»"é‡æ–°è®¡ç®—"æŒ‰é’®æ¥è§¦å‘è®¡ç®—
            console.log('æ¯å…¬å¸ç¨€é‡Šè¡¨æ ¼å·²åˆå§‹åŒ–');
        };

        // åˆ‡æ¢è¾“å…¥æ¨¡å¼
        window.changeInputMode = function() {
            const mode = document.getElementById('input_mode').value;
            
            const tbody = document.getElementById('parent-dilution-tbody');
            if (!tbody) return;
            
            // æ‰€æœ‰æ¨¡å¼ä¸‹éƒ½å…è®¸ç¼–è¾‘ï¼Œåªæ˜¯æ˜¯å¦è‡ªåŠ¨è®¡ç®—çš„åŒºåˆ«
            tbody.querySelectorAll('input').forEach(input => {
                if (input.classList.contains('founder-pct')) {
                    // åˆ›å§‹äººæŒè‚¡å§‹ç»ˆåªè¯»
                    input.readOnly = true;
                    input.style.background = '#f0f0f0';
                    input.style.cursor = 'not-allowed';
                } else {
                    // æ‰€æœ‰å­—æ®µéƒ½å¯ç¼–è¾‘
                    input.readOnly = false;
                    input.style.background = 'white';
                    input.style.cursor = 'text';
                }
            });
        };

        // ä»ä¸Šä¸€è¡Œå¡«å……
        window.fillFromPrevousRow = function() {
            const tbody = document.getElementById('parent-dilution-tbody');
            if (!tbody) return;
            
            for (let i = 1; i < tbody.children.length; i++) {
                // è·³è¿‡å·²é”å®šçš„è¡Œ
                if (isCellLocked(String(i), 'pre-money')) continue;
                
                const row = tbody.children[i];
                const prevRow = tbody.children[i - 1];
                const inputs = row.querySelectorAll('input');
                const prevInputs = prevRow.querySelectorAll('input');
                
                // å¦‚æœæŠ•å‰ä¸ºç©ºï¼Œå¡«å……ä¸Šä¸€è¡Œçš„æŠ•å
                if (!inputs[1].value || inputs[1].value === '0') {
                    const prevPost = parseFloat(prevInputs[3].value) || 0;
                    if (prevPost > 0) {
                        inputs[1].value = prevPost;
                    }
                }
            }
        };

        // åˆ‡æ¢å•ä¸ªå•å…ƒæ ¼é”å®šçŠ¶æ€
        window.toggleSingleCellLock = function(button) {
            const td = button.parentElement;
            const input = td.querySelector('input');
            if (!input) return;
            
            const rowIndex = input.getAttribute('data-row');
            const field = input.getAttribute('data-field');
            
            const key = `${rowIndex}_${field}`;
            
            if (input.hasAttribute('data-locked')) {
                // è§£é”
                input.removeAttribute('data-locked');
                input.classList.remove('locked-cell');
                button.textContent = 'ğŸ”“';
                delete window.lockedCells[key];
            } else {
                // é”å®š
                input.setAttribute('data-locked', 'true');
                input.classList.add('locked-cell');
                button.textContent = 'ğŸ”’';
                if (!window.lockedCells) window.lockedCells = {};
                window.lockedCells[key] = true;
            }
        };
        
        // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦è¢«é”å®š
        function isCellLocked(rowIndex, field) {
            const key = `${rowIndex}_${field}`;
            return window.lockedCells && window.lockedCells[key] === true;
        }

        // é‡æ–°è®¡ç®—æ‰€æœ‰è¡Œï¼ˆä»ç¬¬ä¸€è¡Œå¼€å§‹ï¼‰
        window.recalculateAllRows = function() {
            const tbody = document.getElementById('parent-dilution-tbody');
            if (!tbody) return;
            
            let previousPostMoney = 0;
            let previousFounderPct = 100;
            
            for (let i = 0; i < tbody.children.length; i++) {
                const row = tbody.children[i];
                const inputs = row.querySelectorAll('input');
                
                // æ£€æŸ¥é”å®šçŠ¶æ€
                const preLocked = isCellLocked(String(i), 'pre-money');
                const invLocked = isCellLocked(String(i), 'investment');
                const postLocked = isCellLocked(String(i), 'post-money');
                const pctLocked = isCellLocked(String(i), 'investor-pct');
                
                // è¯»å–å½“å‰å€¼
                let preMoney = parseFloat(inputs[1].value) || 0;
                let investment = parseFloat(inputs[2].value) || 0;
                let postMoney = parseFloat(inputs[3].value) || 0;
                let investorPct = parseFloat(inputs[4].value) || 0;
                
                // æ­¥éª¤1: å¡«å……æŠ•å‰ä¼°å€¼ï¼ˆå¦‚æœæœªé”å®šä¸”ä¸ºç©ºï¼‰
                if (!preLocked) {
                    if (preMoney === 0 && i > 0 && previousPostMoney > 0) {
                        // ä»ä¸Šä¸€è¡Œç»§æ‰¿æŠ•åä¼°å€¼ä½œä¸ºæœ¬è¡Œçš„æŠ•å‰ä¼°å€¼
                        preMoney = previousPostMoney;
                        inputs[1].value = preMoney;
                    }
                }
                
                // æ­¥éª¤2: é‡æ–°è¯»å–æ›´æ–°åçš„å€¼
                preMoney = parseFloat(inputs[1].value) || 0;
                investment = parseFloat(inputs[2].value) || 0;
                postMoney = parseFloat(inputs[3].value) || 0;
                investorPct = parseFloat(inputs[4].value) || 0;
                
                // æ­¥éª¤3: ç¡®ä¿ æŠ•å‰ + æŠ•èµ„é¢ = æŠ•å
                // ä¼˜å…ˆçº§ï¼šå…ˆä¿è¯æŠ•åæœ‰æ­£ç¡®çš„å€¼ï¼Œå¦‚æœæŠ•åè¢«é”å®šï¼Œåˆ™è°ƒæ•´æŠ•å‰æˆ–æŠ•èµ„é¢
                
                const calculatedPostMoney = preMoney + investment;
                
                if (!postLocked && preMoney > 0 && investment > 0) {
                    // æŠ•å‰å’ŒæŠ•èµ„é¢éƒ½æœ‰å€¼ï¼Œè®¡ç®—æŠ•å
                    postMoney = calculatedPostMoney;
                    inputs[3].value = postMoney.toFixed(2);
                } else if (postMoney > 0 && investment > 0 && !preLocked) {
                    // æŠ•åæœ‰å€¼ï¼ŒæŠ•èµ„é¢æœ‰å€¼ï¼ŒæŠ•å‰æœªé”å®šä¸”ä¸ºç©º â†’ è®¡ç®—æŠ•å‰
                    if (preMoney === 0 || Math.abs(preMoney - (postMoney - investment)) > 0.01) {
                        preMoney = postMoney - investment;
                        inputs[1].value = preMoney.toFixed(2);
                    }
                } else if (preMoney > 0 && postMoney > 0 && !invLocked) {
                    // æŠ•å‰å’ŒæŠ•åéƒ½æœ‰å€¼ï¼Œè®¡ç®—æŠ•èµ„é¢
                    investment = postMoney - preMoney;
                    inputs[2].value = investment.toFixed(2);
                }
                
                // æ­¥éª¤4: ä½¿ç”¨è‚¡æƒæ¯”ä¾‹è®¡ç®—ï¼ˆå¦‚æœæä¾›äº†è‚¡æƒæ¯”ä¾‹ï¼‰
                if (investorPct > 0 && !pctLocked) {
                    if (investment > 0 && !postLocked) {
                        // æœ‰æŠ•èµ„é¢å’Œè‚¡æƒæ¯”ä¾‹ï¼Œè®¡ç®—æŠ•å
                        postMoney = investment / (investorPct / 100);
                        inputs[3].value = postMoney.toFixed(2);
                        if (!preLocked && preMoney === 0) {
                            preMoney = postMoney - investment;
                            inputs[1].value = preMoney.toFixed(2);
                        }
                    } else if (postMoney > 0 && !invLocked && investment === 0) {
                        // æœ‰æŠ•åå’Œè‚¡æƒæ¯”ä¾‹ï¼Œè®¡ç®—æŠ•èµ„é¢
                        investment = postMoney * (investorPct / 100);
                        inputs[2].value = investment.toFixed(2);
                        if (!preLocked && preMoney === 0) {
                            preMoney = postMoney - investment;
                            inputs[1].value = preMoney.toFixed(2);
                        }
                    }
                }
                
                // é‡æ–°è¯»å–æœ€ç»ˆå€¼
                preMoney = parseFloat(inputs[1].value) || 0;
                investment = parseFloat(inputs[2].value) || 0;
                postMoney = parseFloat(inputs[3].value) || 0;
                
                // æ­¥éª¤5: è®¡ç®—è‚¡æƒæ¯”ä¾‹
                if (!pctLocked && postMoney > 0 && investment >= 0) {
                    investorPct = (investment / postMoney) * 100;
                    inputs[4].value = investorPct.toFixed(2);
                } else {
                    investorPct = parseFloat(inputs[4].value) || 0;
                }
                
                // æ­¥éª¤6: è®¡ç®—åˆ›å§‹äººæŒè‚¡ï¼ˆç´¯ç§¯ç¨€é‡Šï¼‰
                if (postMoney > 0 && investment >= 0) {
                    const dilutionFactor = (100 - investorPct) / 100;
                    const founderPct = previousFounderPct * dilutionFactor;
                    inputs[5].value = founderPct.toFixed(2);
                    
                    // æ›´æ–°ä¸‹ä¸€è¡Œéœ€è¦çš„å€¼
                    previousPostMoney = postMoney;
                    previousFounderPct = founderPct;
                }
            }
        };

        // è®¡ç®—å•è¡Œæ•°æ®ï¼ˆå·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨recalculateAllRowsï¼‰
        window.calculateParentRow = function(rowIndex, changedField) {
            // ä¸å†ä½¿ç”¨
        };

        // æ·»åŠ æ–°è¡Œ
        window.addParentRow = function() {
            const tbody = document.getElementById('parent-dilution-tbody');
            const rows = tbody.querySelectorAll('tr');
            const lastRow = rows[rows.length - 1];
            const nextIndex = rows.length;
            
            const lastPostMoney = parseFloat(lastRow.querySelector('.post-money').value) || 0;
            const lastFounderPct = parseFloat(lastRow.querySelector('.founder-pct').value) || 0;
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td style="padding: 8px; border: 1px solid #ddd;"><input type="text" value="B" style="width: 100%; border: none; padding: 4px;"></td>
                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                    <input type="number" value="${lastPostMoney}" class="pre-money" data-row="${nextIndex}" data-field="pre-money" style="width: 100%; border: none; padding: 4px; background: white;">
                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                </td>
                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                    <input type="number" value="0" class="investment" data-row="${nextIndex}" data-field="investment" style="width: 100%; border: none; padding: 4px; background: white;">
                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                </td>
                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                    <input type="number" value="${lastPostMoney}" class="post-money" data-row="${nextIndex}" data-field="post-money" style="width: 100%; border: none; padding: 4px; background: #fff8dc;">
                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                </td>
                <td style="padding: 4px; border: 1px solid #ddd; position: relative;">
                    <input type="number" value="0" class="investor-pct" data-row="${nextIndex}" data-field="investor-pct" style="width: 100%; border: none; padding: 4px; background: #fff8dc;">
                    <button onclick="toggleSingleCellLock(this)" class="cell-lock-btn" title="é”å®š/è§£é”">ğŸ”“</button>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="number" value="${lastFounderPct}" class="founder-pct" data-row="${nextIndex}" readonly style="width: 100%; border: none; padding: 4px; background: #f0f0f0;">
                </td>
            `;
            tbody.appendChild(newRow);
            
            // é‡æ–°è®¡ç®—æ‰€æœ‰è¡Œ
            recalculateAllRows();
        };

        // ä»è¡¨æ ¼åˆ†æ
        window.analyzeParentFromTable = async function() {
            showLoading();
            
            try {
                const rows = document.querySelectorAll('#parent-dilution-tbody tr');
                const rounds = [];
                let firstPreMoney = parseFloat(document.querySelector('.pre-money').value) || 0;
                
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    const roundName = inputs[0].value || 'Round';
                    const amount = parseFloat(inputs[2].value) || 0;
                    
                    if (amount > 0) {
                        rounds.push({
                            round: roundName,
                            amount: amount
                        });
                    }
                });
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        parent_dilution: { pre_money: firstPreMoney, rounds: rounds }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayParentResults(data.results.parent_dilution);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            } finally {
                hideLoading();
            }
        };

        // åˆå§‹åŒ–lockedCellså¯¹è±¡
        window.lockedCells = window.lockedCells || {};
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ‰€æœ‰å‡½æ•°å·²å‡†å¤‡å¥½');
            window.lockedCells = {}; // ç¡®ä¿lockedCellsè¢«åˆå§‹åŒ–
            initParentDilutionTable();
            
            // è®¾ç½®ä¸ºæ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼ˆé»˜è®¤å…³é—­è‡ªåŠ¨è®¡ç®—ï¼‰
            document.getElementById('input_mode').value = 'manual';
            autoCalculateEnabled = false;
            changeInputMode();
            
            recalculateAllRows(); // åˆå§‹è®¡ç®—æ‰€æœ‰è¡Œ
        });
    </script>
</body>
</html>

