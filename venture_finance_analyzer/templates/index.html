<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venture Finance Analyzer - 融资决策分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }
        
        .tab-button {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button:hover {
            color: #667eea;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .round-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .round-item input {
            flex: 1;
        }

        .round-item input[type="number"] {
            min-width: 120px;
        }

        .round-item:has(input[type="number"][min="0"][max="1"]) {
            grid-template-columns: 2fr 1fr;
        }

        /* 响应式布局 */
        @media (max-width: 768px) {
            .round-item {
                flex-direction: column;
                gap: 10px;
            }

            .round-item input {
                width: 100%;
            }
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .results {
            margin-top: 30px;
        }
        
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .result-card h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h5 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 Venture Finance Analyzer</h1>
            <p>股权稀释、估值分析与风险模拟</p>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab(0)">母公司稀释</button>
            <button class="tab-button" onclick="switchTab(1)">JV稀释</button>
            <button class="tab-button" onclick="switchTab(2)">退出估值</button>
            <button class="tab-button" onclick="switchTab(3)">投前投后对比</button>
            <button class="tab-button" onclick="switchTab(4)">股比收益分析</button>
        </div>
        
        <!-- Tab 1: 母公司稀释 -->
        <div class="tab-content active">
            <div class="form-section">
                <h3>母公司股权稀释分析</h3>
                <div class="form-group">
                    <label>初始估值 (万元)</label>
                    <input type="number" id="parent_pre_money" value="2000" step="100">
                </div>
                <div class="form-group">
                    <label>融资轮次</label>
                    <div id="parent-rounds">
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="Seed">
                            <input type="number" placeholder="投资额(万元)" value="500" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="A">
                            <input type="number" placeholder="投资额(万元)" value="1500" step="100">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addRound('parent')">+ 添加轮次</button>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeParent()">分析</button>
            <div id="parent-results" class="results"></div>
        </div>
        
        <!-- Tab 2: JV稀释 -->
        <div class="tab-content">
            <div class="form-section">
                <h3>合资企业股权稀释分析</h3>
                <div class="form-group">
                    <label>初始投资 (万元)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <label style="font-size: 0.9em;">AgInno</label>
                            <input type="number" id="jv_ag_inno" value="100" step="10">
                        </div>
                        <div>
                            <label style="font-size: 0.9em;">Partner</label>
                            <input type="number" id="jv_partner" value="150" step="10">
                        </div>
                        <div>
                            <label style="font-size: 0.9em;">Grant</label>
                            <input type="number" id="jv_grant" value="0" step="10">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>融资轮次</label>
                    <div id="jv-rounds">
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="A">
                            <input type="number" placeholder="投资额(万元)" value="500" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="B">
                            <input type="number" placeholder="投资额(万元)" value="1000" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="C">
                            <input type="number" placeholder="投资额(万元)" value="2000" step="100">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addRound('jv')">+ 添加轮次</button>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeJV()">分析</button>
            <div id="jv-results" class="results"></div>
        </div>
        
        <!-- Tab 3: 退出估值 -->
        <div class="tab-content">
            <div class="form-section">
                <h3>退出估值与风险分析</h3>
                <div class="form-group">
                    <label>未来现金流 (万元, 用逗号分隔)</label>
                    <input type="text" id="cash_flows" value="200,400,800,1200,1500">
                    <small style="color: #666;">例如: 200,400,800,1200,1500</small>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>折现率</label>
                        <input type="number" id="discount_rate" value="0.12" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>永续增长率</label>
                        <input type="number" id="growth_rate" value="0.03" step="0.01" min="0" max="0.1">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>投资者持股比例</label>
                        <input type="number" id="investor_share" value="0.2" step="0.1" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>投资金额 (万元)</label>
                        <input type="number" id="invested_amount" value="1500" step="100">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="run_montecarlo" checked>
                        运行蒙特卡洛风险分析
                    </label>
                    <div style="margin-top: 10px;">
                        <label>模拟次数</label>
                        <input type="number" id="montecarlo_trials" value="10000" step="1000">
                        <label>现金流波动率</label>
                        <input type="number" id="cf_volatility" value="0.2" step="0.1">
                    </div>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeExit()">分析</button>
            <div id="exit-results" class="results"></div>
        </div>

        <!-- Tab 4: 投前投后对比 -->
        <div class="tab-content">
            <div class="form-section">
                <h3>投前/投后估值对比分析</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>投前估值 (万元)</label>
                        <input type="number" id="pre_money_valuation" value="2000" step="100" min="1">
                    </div>
                    <div class="form-group">
                        <label>投后估值 (万元)</label>
                        <input type="number" id="post_money_valuation" value="5000" step="100" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>投资轮次</label>
                    <div id="valuation-rounds">
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="Seed">
                            <input type="number" placeholder="投资额(万元)" value="500" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="A轮">
                            <input type="number" placeholder="投资额(万元)" value="1500" step="100">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="B轮">
                            <input type="number" placeholder="投资额(万元)" value="1000" step="100">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addRound('valuation')">+ 添加轮次</button>
                </div>

                <div class="form-group">
                    <label>合伙人股权分配</label>
                    <div id="partner-equity-splits">
                        <div class="round-item">
                            <input type="text" placeholder="合伙人姓名" value="创始人A">
                            <input type="number" placeholder="股权比例(0-1)" value="0.4" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="合伙人姓名" value="创始人B">
                            <input type="number" placeholder="股权比例(0-1)" value="0.3" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="合伙人姓名" value="早期员工">
                            <input type="number" placeholder="股权比例(0-1)" value="0.2" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="合伙人姓名" value="投资人">
                            <input type="number" placeholder="股权比例(0-1)" value="0.1" step="0.01" min="0" max="1">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addPartner('partner-equity-splits')">+ 添加合伙人</button>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeValuationComparison()">分析</button>
            <div id="valuation-results" class="results"></div>
        </div>

        <!-- Tab 5: 股比收益分析 -->
        <div class="tab-content">
            <div class="form-section">
                <h3>多轮次股比和收益分析</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>初始估值 (万元)</label>
                        <input type="number" id="initial_valuation" value="1000" step="100" min="1">
                    </div>
                    <div class="form-group">
                        <label>退出时估值 (万元)</label>
                        <input type="number" id="exit_valuation" value="10000" step="100" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>初始合伙人及其股权比例</label>
                    <div id="initial-partners">
                        <div class="round-item">
                            <input type="text" placeholder="合伙人姓名" value="创始人A">
                            <input type="number" placeholder="股权比例(0-1)" value="0.5" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="合伙人姓名" value="创始人B">
                            <input type="number" placeholder="股权比例(0-1)" value="0.3" step="0.01" min="0" max="1">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="合伙人姓名" value="早期投资人">
                            <input type="number" placeholder="股权比例(0-1)" value="0.2" step="0.01" min="0" max="1">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addPartner('initial-partners')">+ 添加合伙人</button>
                </div>

                <div class="form-group">
                    <label>投资轮次</label>
                    <div id="equity-rounds">
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="A轮">
                            <input type="number" placeholder="投资额(万元)" value="1000" step="100">
                            <input type="number" placeholder="新投资者股权比例(0-1)" value="0.15" step="0.01" min="0" max="1" title="新投资者获得的具体股权比例">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="B轮">
                            <input type="number" placeholder="投资额(万元)" value="3000" step="100">
                            <input type="number" placeholder="新投资者股权比例(0-1)" value="0.2" step="0.01" min="0" max="1" title="新投资者获得的具体股权比例">
                        </div>
                        <div class="round-item">
                            <input type="text" placeholder="轮次名称" value="C轮">
                            <input type="number" placeholder="投资额(万元)" value="5000" step="100">
                            <input type="number" placeholder="新投资者股权比例(0-1)" value="0.25" step="0.01" min="0" max="1" title="新投资者获得的具体股权比例">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addEquityRound('equity-rounds')">+ 添加轮次</button>
                </div>
            </div>
            <button class="btn btn-success" onclick="analyzeEquityReturns()">分析</button>
            <div id="equity-results" class="results"></div>
        </div>

        <div class="loading" id="loading">
            🔄 正在分析中...
        </div>
    </div>
    
    <script>
        // 确保函数在全局作用域
        window.switchTab = function(index) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            buttons.forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        };

        window.addRound = function(type) {
            const roundsDiv = document.getElementById(type + '-rounds');
            const newRound = document.createElement('div');
            newRound.className = 'round-item';
            newRound.innerHTML = `
                <input type="text" placeholder="轮次名称">
                <input type="number" placeholder="投资额(万元)" value="0" step="100">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">删除</button>
            `;
            roundsDiv.appendChild(newRound);
        };

        // 添加合伙人
        window.addPartner = function(containerId) {
            const container = document.getElementById(containerId);
            const newPartner = document.createElement('div');
            newPartner.className = 'round-item';
            newPartner.innerHTML = `
                <input type="text" placeholder="合伙人姓名">
                <input type="number" placeholder="股权比例(0-1)" value="0" step="0.01" min="0" max="1">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">删除</button>
            `;
            container.appendChild(newPartner);
        };

        // 添加股比轮次（带股权比例输入）
        window.addEquityRound = function(containerId) {
            const container = document.getElementById(containerId);
            const newRound = document.createElement('div');
            newRound.className = 'round-item';
            newRound.innerHTML = `
                <input type="text" placeholder="轮次名称" style="flex: 1.5;">
                <input type="number" placeholder="投资额(万元)" value="0" step="100" style="flex: 1;">
                <input type="number" placeholder="新投资者股权比例(0-1)" value="0" step="0.01" min="0" max="1" style="flex: 1;" title="新投资者获得的具体股权比例">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">删除</button>
            `;
            container.appendChild(newRound);
        };

        // 显示加载状态
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // 母公司稀释分析
        window.analyzeParent = async function() {
            showLoading();
            
            try {
                const preMoney = parseFloat(document.getElementById('parent_pre_money').value);
                const rounds = Array.from(document.querySelectorAll('#parent-rounds .round-item')).map(item => {
                    const inputs = item.querySelectorAll('input');
                    return {
                        round: inputs[0].value || 'Round',
                        amount: parseFloat(inputs[1].value)
                    };
                });
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        parent_dilution: { pre_money: preMoney, rounds: rounds }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayParentResults(data.results.parent_dilution);
                } else {
                    alert('分析失败: ' + data.error);
                }
            } catch (error) {
                alert('错误: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 显示母公司结果
        function displayParentResults(data) {
            const resultsDiv = document.getElementById('parent-results');
            
            let html = '<div class="result-card"><h4>分析结果</h4>';
            html += `<div class="stats-grid">
                <div class="stat-card">
                    <h5>最终创始人持股</h5>
                    <div class="value">${data.final_dilution.toFixed(2)}%</div>
                </div>
            </div>`;
            
            // 表格
            html += '<table><thead><tr><th>轮次</th><th>投前估值</th><th>投资额</th><th>投后估值</th><th>创始人持股</th><th>新投资者持股</th></tr></thead><tbody>';
            
            data.data.forEach(row => {
                html += `<tr>
                    <td>${row.round}</td>
                    <td>${row.pre_money.toFixed(0)}万</td>
                    <td>${row.investment.toFixed(0)}万</td>
                    <td>${row.post_money.toFixed(0)}万</td>
                    <td>${(row.founders_pct * 100).toFixed(2)}%</td>
                    <td>${(row.new_investor_pct * 100).toFixed(2)}%</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // 图表
            html += '<div class="chart-container"><canvas id="parentChart"></canvas></div>';
            
            resultsDiv.innerHTML = html;
            
            // 绘制图表
            setTimeout(() => {
                const ctx = document.getElementById('parentChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(r => r.round),
                        datasets: [{
                            label: '创始人持股比例',
                            data: data.data.map(r => r.founders_pct * 100),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: '股权稀释趋势' }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { suffix: '%' } }
                        }
                    }
                });
            }, 100);
        };

        // JV稀释分析
        window.analyzeJV = async function() {
            showLoading();
            
            try {
                const initialInv = {
                    ag_inno: parseFloat(document.getElementById('jv_ag_inno').value),
                    partner: parseFloat(document.getElementById('jv_partner').value),
                    grant: parseFloat(document.getElementById('jv_grant').value)
                };
                
                const rounds = Array.from(document.querySelectorAll('#jv-rounds .round-item')).map(item => {
                    const inputs = item.querySelectorAll('input');
                    return {
                        round: inputs[0].value || 'Round',
                        amount: parseFloat(inputs[1].value)
                    };
                });
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jv_dilution: { initial_investments: initialInv, rounds: rounds }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayJVResults(data.results.jv_dilution);
                } else {
                    alert('分析失败: ' + data.error);
                }
            } catch (error) {
                alert('错误: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 显示JV结果
        function displayJVResults(data) {
            const resultsDiv = document.getElementById('jv-results');
            
            const final = data.final_ownership;
            
            let html = '<div class="result-card"><h4>分析结果</h4>';
            html += `<div class="stats-grid">
                <div class="stat-card">
                    <h5>AgInno持股</h5>
                    <div class="value">${(final.ag_inno_pct * 100).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h5>Partner持股</h5>
                    <div class="value">${(final.partner_pct * 100).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h5>Grant持股</h5>
                    <div class="value">${(final.grant_pct * 100).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h5>外部投资者</h5>
                    <div class="value">${(final.external_pct * 100).toFixed(2)}%</div>
                </div>
            </div>`;
            
            // 表格
            html += '<table><thead><tr><th>轮次</th><th>投前估值</th><th>投资额</th><th>投后估值</th><th>AgInno</th><th>Partner</th><th>Grant</th><th>外部</th></tr></thead><tbody>';
            
            data.data.forEach(row => {
                html += `<tr>
                    <td>${row.round}</td>
                    <td>${row.pre_money.toFixed(0)}万</td>
                    <td>${row.investment.toFixed(0)}万</td>
                    <td>${row.post_money.toFixed(0)}万</td>
                    <td>${(row.ag_inno_pct * 100).toFixed(2)}%</td>
                    <td>${(row.partner_pct * 100).toFixed(2)}%</td>
                    <td>${(row.grant_pct * 100).toFixed(2)}%</td>
                    <td>${(row.external_pct * 100).toFixed(2)}%</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // 图表
            html += '<div class="chart-container"><canvas id="jvChart"></canvas></div>';
            
            resultsDiv.innerHTML = html;
            
            // 绘制图表
            setTimeout(() => {
                const ctx = document.getElementById('jvChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(r => r.round),
                        datasets: [
                            { label: 'AgInno', data: data.data.map(r => r.ag_inno_pct * 100), borderColor: '#28a745', tension: 0.4 },
                            { label: 'Partner', data: data.data.map(r => r.partner_pct * 100), borderColor: '#17a2b8', tension: 0.4 },
                            { label: 'Grant', data: data.data.map(r => r.grant_pct * 100), borderColor: '#ffc107', tension: 0.4 },
                            { label: '外部投资者', data: data.data.map(r => r.external_pct * 100), borderColor: '#dc3545', tension: 0.4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'JV股权稀释趋势' } },
                        scales: { y: { beginAtZero: true, ticks: { suffix: '%' } } }
                    }
                });
            }, 100);
        };

        // 退出估值分析
        window.analyzeExit = async function() {
            showLoading();
            
            try {
                const cashFlows = document.getElementById('cash_flows').value.split(',').map(x => parseFloat(x.trim()));
                const discountRate = parseFloat(document.getElementById('discount_rate').value);
                const growthRate = parseFloat(document.getElementById('growth_rate').value);
                const investorShare = parseFloat(document.getElementById('investor_share').value);
                const investedAmount = parseFloat(document.getElementById('invested_amount').value);
                const runMC = document.getElementById('run_montecarlo').checked;
                const mcTrials = parseInt(document.getElementById('montecarlo_trials').value);
                const cfVolatility = parseFloat(document.getElementById('cf_volatility').value);
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        exit_analysis: {
                            cash_flows: cashFlows,
                            discount_rate: discountRate,
                            growth_rate: growthRate,
                            investor_share: investorShare,
                            invested_amount: investedAmount
                        },
                        run_montecarlo: runMC,
                        montecarlo_trials: mcTrials,
                        cf_volatility: cfVolatility
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayExitResults(data.results);
                } else {
                    alert('分析失败: ' + data.error);
                }
            } catch (error) {
                alert('错误: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 显示退出分析结果
        function displayExitResults(results) {
            const resultsDiv = document.getElementById('exit-results');
            
            const exit = results.exit_analysis;
            
            let html = '<div class="result-card"><h4>DCF估值结果</h4>';
            html += `<div class="stats-grid">
                <div class="stat-card">
                    <h5>现金流现值</h5>
                    <div class="value">${exit.pv_cashflows.toFixed(0)}万</div>
                </div>
                <div class="stat-card">
                    <h5>终值</h5>
                    <div class="value">${exit.terminal_value.toFixed(0)}万</div>
                </div>
                <div class="stat-card">
                    <h5>退出估值</h5>
                    <div class="value">${exit.exit_valuation.toFixed(0)}万</div>
                </div>
                <div class="stat-card">
                    <h5>投资回报率</h5>
                    <div class="value">${(exit.investor_roi * 100).toFixed(2)}%</div>
                </div>
            </div></div>`;
            
            // 蒙特卡洛结果
            if (results.montecarlo) {
                const mc = results.montecarlo;
                html += '<div class="result-card"><h4>蒙特卡洛风险分析</h4>';
                html += '<p>模拟次数: ' + mc.trials_count + '</p>';
                html += '<div class="stats-grid">';
                html += '<div class="stat-card"><h5>估值均值</h5><div class="value">' + mc.mean_exit_value.toFixed(0) + '万</div></div>';
                html += '<div class="stat-card"><h5>估值中位数</h5><div class="value">' + mc.median_exit_value.toFixed(0) + '万</div></div>';
                html += '<div class="stat-card"><h5>估值10%分位</h5><div class="value">' + mc.p10_exit_value.toFixed(0) + '万</div></div>';
                html += '<div class="stat-card"><h5>估值90%分位</h5><div class="value">' + mc.p90_exit_value.toFixed(0) + '万</div></div>';
                html += '<div class="stat-card"><h5>ROI均值</h5><div class="value">' + (mc.mean_roi * 100).toFixed(2) + '%</div></div>';
                html += '<div class="stat-card"><h5>ROI中位数</h5><div class="value">' + (mc.median_roi * 100).toFixed(2) + '%</div></div>';
                html += '<div class="stat-card"><h5>ROI 10%分位</h5><div class="value">' + (mc.p10_roi * 100).toFixed(2) + '%</div></div>';
                html += '<div class="stat-card"><h5>ROI 90%分位</h5><div class="value">' + (mc.p90_roi * 100).toFixed(2) + '%</div></div>';
                html += '</div></div>';
            }
            
            resultsDiv.innerHTML = html;
        };

        // 投前投后估值对比分析
        window.analyzeValuationComparison = async function() {
            showLoading();

            try {
                const preMoney = parseFloat(document.getElementById('pre_money_valuation').value);
                const postMoney = parseFloat(document.getElementById('post_money_valuation').value);

                const rounds = Array.from(document.querySelectorAll('#valuation-rounds .round-item')).map(item => {
                    const inputs = item.querySelectorAll('input');
                    return {
                        round: inputs[0].value || 'Round',
                        amount: parseFloat(inputs[1].value)
                    };
                });

                const partnerSplits = {};
                Array.from(document.querySelectorAll('#partner-equity-splits .round-item')).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const name = inputs[0].value;
                    const equity = parseFloat(inputs[1].value);
                    if (name && equity > 0) {
                        partnerSplits[name] = equity;
                    }
                });

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        valuation_comparison: {
                            pre_money: preMoney,
                            post_money: postMoney,
                            investment_rounds: rounds,
                            partner_equity_splits: partnerSplits
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayValuationComparisonResults(data.results.valuation_comparison);
                } else {
                    alert('分析失败: ' + data.error);
                }
            } catch (error) {
                alert('错误: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 显示投前投后对比结果
        function displayValuationComparisonResults(data) {
            const resultsDiv = document.getElementById('valuation-results');

            let html = '<div class="result-card"><h4>投前/投后估值对比分析</h4>';

            // 核心指标
            html += '<div class="stats-grid">';
            html += `<div class="stat-card">
                <h5>投前估值</h5>
                <div class="value">${data.data.pre_money_valuation.toFixed(0)}万</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>投后估值</h5>
                <div class="value">${data.data.post_money_valuation.toFixed(0)}万</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>估值倍数</h5>
                <div class="value">${data.data.valuation_multiple.toFixed(2)}倍</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>投资ROI</h5>
                <div class="value">${data.data.investor_roi_percentage.toFixed(2)}%</div>
            </div>`;
            html += '</div>';

            // 详细表格
            html += '<h5 style="margin-top: 30px; color: #333;">详细分析结果</h5>';
            html += '<table><thead><tr><th>项目</th><th>数值</th><th>单位</th><th>说明</th></tr></thead><tbody>';

            data.table.forEach(row => {
                html += `<tr>
                    <td>${row.项目}</td>
                    <td>${typeof row.数值 === 'number' ? row.数值.toFixed(2) : row.数值}</td>
                    <td>${row.单位}</td>
                    <td>${row.说明}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            // 合伙人收益图表
            const partners = data.data.partner_returns;
            if (Object.keys(partners).length > 0) {
                html += '<div class="chart-container"><canvas id="valuationChart"></canvas></div>';

                resultsDiv.innerHTML = html;

                // 绘制合伙人收益图表
                setTimeout(() => {
                    const ctx = document.getElementById('valuationChart').getContext('2d');
                    const labels = Object.keys(partners);
                    const returnData = labels.map(p => partners[p].return_amount);

                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '收益分配',
                                data: returnData,
                                backgroundColor: [
                                    '#667eea', '#764ba2', '#f093fb', '#f5576c',
                                    '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: '合伙人收益分配' },
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }, 100);
            } else {
                resultsDiv.innerHTML = html;
            }
        }

        // 股比收益分析
        window.analyzeEquityReturns = async function() {
            showLoading();

            try {
                const initialValuation = parseFloat(document.getElementById('initial_valuation').value);
                const exitValuation = parseFloat(document.getElementById('exit_valuation').value);

                const initialPartners = {};
                Array.from(document.querySelectorAll('#initial-partners .round-item')).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const name = inputs[0].value;
                    const equity = parseFloat(inputs[1].value);
                    if (name && equity > 0) {
                        initialPartners[name] = equity;
                    }
                });

                const rounds = Array.from(document.querySelectorAll('#equity-rounds .round-item')).map(item => {
                    const inputs = item.querySelectorAll('input');
                    return {
                        round: inputs[0].value || 'Round',
                        amount: parseFloat(inputs[1].value)
                    };
                });

                const newInvestorsPerRound = {};
                Array.from(document.querySelectorAll('#equity-rounds .round-item')).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const roundName = inputs[0].value;
                    const equityRatio = parseFloat(inputs[2].value);
                    if (roundName && equityRatio > 0) {
                        newInvestorsPerRound[roundName] = equityRatio;
                    }
                });

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        equity_returns: {
                            initial_valuation: initialValuation,
                            investment_rounds: rounds,
                            initial_partners: initialPartners,
                            new_investors_per_round: newInvestorsPerRound
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayEquityReturnsResults(data.results.equity_returns);
                } else {
                    alert('分析失败: ' + data.error);
                }
            } catch (error) {
                alert('错误: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 显示股比收益分析结果
        function displayEquityReturnsResults(data) {
            const resultsDiv = document.getElementById('equity-results');

            let html = '<div class="result-card"><h4>多轮次股比和收益分析</h4>';

            // 核心指标
            html += '<div class="stats-grid">';
            html += `<div class="stat-card">
                <h5>总投资额</h5>
                <div class="value">${data.data.total_investment.toFixed(0)}万</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>退出估值</h5>
                <div class="value">${data.data.exit_valuation.toFixed(0)}万</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>总收益</h5>
                <div class="value">${data.data.total_return.toFixed(0)}万</div>
            </div>`;
            html += `<div class="stat-card">
                <h5>整体ROI</h5>
                <div class="value">${data.data.roi_percentage.toFixed(2)}%</div>
            </div>`;
            html += '</div>';

            // 详细表格
            html += '<h5 style="margin-top: 30px; color: #333;">详细收益分析</h5>';
            html += '<table><thead><tr><th>项目</th><th>数值</th><th>单位</th><th>说明</th></tr></thead><tbody>';

            data.table.forEach(row => {
                html += `<tr>
                    <td>${row.项目}</td>
                    <td>${typeof row.数值 === 'number' ? row.数值.toFixed(2) : row.数值}</td>
                    <td>${row.单位}</td>
                    <td>${row.说明}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            // 模拟过程表格
            if (data.data.simulation_data && data.data.simulation_data.length > 0) {
                html += '<div class="result-card"><h4>融资过程模拟</h4>';
                html += '<table><thead><tr><th>轮次</th><th>投资额</th><th>投前估值</th><th>投后估值</th><th>新投资者股权</th>';

                // 获取所有合伙人名称
                const partners = Object.keys(data.data.final_equity_distribution);
                partners.forEach(partner => {
                    html += `<th>${partner}股权</th>`;
                });

                html += '</tr></thead><tbody>';

                data.data.simulation_data.forEach(row => {
                    html += `<tr>
                        <td>${row.轮次}</td>
                        <td>${row.投资额.toFixed(0)}万</td>
                        <td>${row.投前估值.toFixed(0)}万</td>
                        <td>${row.投后估值.toFixed(0)}万</td>
                        <td>${row.新投资者股权.toFixed(2)}%</td>`;

                    partners.forEach(partner => {
                        const equityKey = `${partner}_股权`;
                        const equity = row[equityKey] || 0;
                        html += `<td>${equity.toFixed(2)}%</td>`;
                    });

                    html += '</tr>';
                });

                html += '</tbody></table></div>';
            }

            // 最终股权分布图表
            const finalEquity = data.data.final_equity_distribution;
            if (Object.keys(finalEquity).length > 0) {
                html += '<div class="chart-container"><canvas id="equityChart"></canvas></div>';

                resultsDiv.innerHTML = html;

                // 绘制最终股权分布图表
                setTimeout(() => {
                    const ctx = document.getElementById('equityChart').getContext('2d');
                    const labels = Object.keys(finalEquity);
                    const equityData = labels.map(p => finalEquity[p] * 100);

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '最终股权比例',
                                data: equityData,
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: '#667eea',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: '最终股权分布' },
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { suffix: '%' }
                                }
                            }
                        }
                    });
                }, 100);
            } else {
                resultsDiv.innerHTML = html;
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，所有函数已准备好');
        });
    </script>
</body>
</html>

